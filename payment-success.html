<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran Berhasil - Hanzamas.tech</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-darker), var(--bg-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-family);
        }

        .success-container {
            max-width: 600px;
            width: 90%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: var(--space-3xl);
            text-align: center;
            box-shadow: var(--shadow-primary);
            animation: successSlideIn 0.8s ease-out;
        }

        .success-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-xl);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            animation: successBounce 1s ease-out;
            position: relative;
        }

        .success-icon::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            opacity: 0.3;
            animation: successGlow 2s ease-in-out infinite;
        }

        .success-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin-bottom: var(--space-lg);
            color: #4CAF50;
            text-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        .success-message {
            font-size: var(--font-size-lg);
            color: var(--text-muted);
            margin-bottom: var(--space-2xl);
            line-height: 1.6;
        }

        .order-details {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: var(--space-xl);
            margin-bottom: var(--space-2xl);
            text-align: left;
        }

        .order-details h3 {
            color: var(--accent-color);
            margin-bottom: var(--space-lg);
            text-align: center;
            font-size: var(--font-size-xl);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: var(--font-size-base);
            color: var(--text-light);
            font-weight: 600;
            font-family: monospace;
        }

        .success-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-success {
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            transition: var(--transition);
            cursor: pointer;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(229, 115, 147, 0.4);
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            animation: confettiFall 3s ease-out infinite;
        }

        @keyframes successSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes successBounce {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes successGlow {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.6;
            }
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .success-container {
                width: 95%;
                padding: var(--space-xl);
            }

            .success-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .success-title {
                font-size: var(--font-size-2xl);
            }

            .success-actions {
                flex-direction: column;
            }

            .btn-success {
                width: 100%;
                justify-content: center;
            }

            .detail-row {
                flex-direction: column;
                text-align: center;
                gap: var(--space-xs);
            }
        }
    </style>
</head>

<body>
    <div class="success-container">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        
        <h1 class="success-title">Pembayaran Berhasil!</h1>
        
        <p class="success-message">
            Terima kasih! Pembayaran Anda telah berhasil diproses dan dikonfirmasi. 
            Kami akan segera memproses pesanan Anda.
        </p>

        <div class="order-details" id="orderDetails">
            <h3><i class="fas fa-receipt"></i> Detail Pembayaran</h3>
            <div class="detail-row">
                <span class="detail-label">Order ID</span>
                <span class="detail-value" id="orderId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Nomor Referensi</span>
                <span class="detail-value" id="referenceId">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value" style="color: #4CAF50;">BERHASIL</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Waktu</span>
                <span class="detail-value" id="paymentTime">-</span>
            </div>
        </div>

        <div class="success-actions">
            <a href="/fulfillment.html?merchantOrderId=" id="fulfillmentLink" class="btn-success btn-primary">
                <i class="fas fa-box-open"></i>
                Pengiriman Produk
            </a>
            <a href="/" class="btn-success btn-secondary">
                <i class="fas fa-home"></i>
                Kembali ke Beranda
            </a>
            <button id="rateOrderBtn" class="btn-success btn-secondary">
                <i class="fas fa-star"></i>
                Beri Rating
            </button>
        </div>
    </div>

    <!-- Celebration Effect -->
    <div class="celebration" id="celebration"></div>

    <script>
        // Extract URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Populate order details
        function populateOrderDetails() {
            const merchantOrderId = getUrlParameter('merchantOrderId');
            const reference = getUrlParameter('reference');
            const resultCode = getUrlParameter('resultCode');

            // Check if result code is valid for success page (00 = success)
            if (resultCode && resultCode !== '00') {
                // Redirect to payment-status page for proper handling
                window.location.href = '/payment-status.html?merchantOrderId=' + merchantOrderId;
                return;
            }

            document.getElementById('orderId').textContent = merchantOrderId || 'N/A';
            document.getElementById('referenceId').textContent = reference || 'N/A';
            document.getElementById('paymentTime').textContent = new Date().toLocaleString('id-ID');
            
            // Update fulfillment link to include merchantOrderId
            const fulfillmentLink = document.getElementById('fulfillmentLink');
            if (fulfillmentLink && merchantOrderId) {
                fulfillmentLink.href = `/fulfillment.html?merchantOrderId=${merchantOrderId}`;
            }
            
            // Update rating button link
            const rateOrderBtn = document.getElementById('rateOrderBtn');
            if (rateOrderBtn && merchantOrderId) {
                rateOrderBtn.addEventListener('click', function() {
                    window.location.href = `/rating.html?merchantOrderId=${merchantOrderId}`;
                });
            }

            // Don't remove currentOrderId yet since we need it for fulfillment
            // We'll remove it after fulfillment is complete
        }

        // Create confetti animation
        function createConfetti() {
            const celebration = document.getElementById('celebration');
            const colors = ['#e5739a', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                celebration.appendChild(confetti);
            }

            // Remove confetti after animation
            setTimeout(() => {
                celebration.innerHTML = '';
            }, 6000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get key parameters
            const merchantOrderId = getUrlParameter('merchantOrderId');
            const reference = getUrlParameter('reference');
            const resultCode = getUrlParameter('resultCode');
            
            // Handle back button navigation from Duitku
            // Track if this is a back/forward navigation or direct load
            const isFromBackButton = (function() {
                try {
                    // Modern browsers
                    if (performance && performance.getEntriesByType && performance.getEntriesByType('navigation').length) {
                        const navEntry = performance.getEntriesByType('navigation')[0];
                        return navEntry.type === 'back_forward';
                    }
                    // Legacy fallback
                    else if (window.performance && window.performance.navigation) {
                        return window.performance.navigation.type === 2;
                    }
                } catch (e) {
                    console.error('Error detecting navigation type:', e);
                }
                return false;
            })();
            
            // If coming from back button, redirect to payment status page for verification
            if (isFromBackButton) {
                window.location.href = '/payment-status.html' + (merchantOrderId ? '?merchantOrderId=' + merchantOrderId : '');
                return;
            }
            
            // Create a new history entry to track this was a direct load
            history.replaceState({directLoad: true}, document.title);
            
            // Validate that we have required parameters and valid result code
            if (!merchantOrderId || !reference || resultCode !== '00') {
                // Redirect to the payment status page for proper handling
                window.location.href = '/payment-status.html' + (merchantOrderId ? '?merchantOrderId=' + merchantOrderId : '');
                return;
            }
            
            // Additional verification with backend API
            // Import configuration with API endpoints
            const API_BASE_URL = window.location.hostname === 'localhost' 
                ? 'http://localhost:5000' 
                : 'https://api.hanzamas.tech';
                
            const CHECK_PAYMENT_URL = API_BASE_URL + '/api/check_payment';
            
            // Verify with backend
            async function verifyPayment() {
                try {
                    const response = await fetch(`${CHECK_PAYMENT_URL}?merchantOrderId=${merchantOrderId}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (!data.found || data.status !== 'SUCCESS') {
                            // Payment not found or not successful, redirect to status page
                            window.location.href = '/payment-status.html?merchantOrderId=' + merchantOrderId;
                        }
                    }
                } catch (error) {
                    console.error('Error verifying payment:', error);
                    // Continue showing success page on error, as we already have resultCode='00'
                }
            }
            
            // Try to verify, but don't block the page load
            verifyPayment().catch(console.error);
            
            // Save order information to localStorage for fulfillment process
            try {
                const orders = JSON.parse(localStorage.getItem('hanzamas_orders') || '[]');
                const existingOrderIndex = orders.findIndex(o => o.merchantOrderId === merchantOrderId);
                
                const orderData = {
                    merchantOrderId: merchantOrderId,
                    reference: reference,
                    status: 'PAID',
                    lastUpdated: new Date().toISOString()
                };
                
                if (existingOrderIndex >= 0) {
                    orders[existingOrderIndex] = {
                        ...orders[existingOrderIndex],
                        ...orderData
                    };
                } else {
                    orders.push(orderData);
                }
                
                localStorage.setItem('hanzamas_orders', JSON.stringify(orders));
            } catch (err) {
                console.error('Error updating order data:', err);
            }
            
            populateOrderDetails();
            createConfetti();
            
            // Play success sound (optional)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D2u2AaAx1+y+7VgDMGGGu+8+OZQQ0PVqzn77BdGAg+ltryxnkpBSl+zPLaizsIGGS57OGYSAwKUKXh8bliHgg2jdXzzn0vBSF1xe/eizEIHWq+8+OYQAwNVarg7q5cGgw9k9n1wXIqBCtza+LdnAoQTqrg7q1dGQs9k9n1wXIqBC13yO7VgTgHhAAAAA==');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}
        });
    </script>
</body>
</html>
